{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Add Cooling Data{% endblock %}
{% block stylesheets %}<link rel="stylesheet" type="text/css" href="{% static 'assets/css/user_first_page.css' %}">
{% endblock stylesheets %}

{% block content %}
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} message" id="message-{{ forloop.counter }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div style="display: flex; justify-content: space-between; padding: 20px;">
    <a href="javascript:history.back()" class="btn btn-primary btn-sm" style="text-decoration: none; font-size: 16px;">Back</a>
    <a href="{% url 'cooling_data_list' control_point.location.name %}" style="text-decoration: none; font-size: 16px;" class="btn btn-primary btn-sm">Show cooling data</a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Add Cooling Data</h4>
            </div>
            <div class="card-body">
            
                    
                    <!-- Storage Location -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Storage Location</label>
                        <input type="text" name="storage_location" class="form-control" readonly value="{{control_point.location.name}}">
                    </div>

                    <!-- Sub Storage Location -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Sub Storage Location</label>
                        <input type="text" name="sub_storage_location" class="form-control" readonly value="{{control_point.name}}">
                    </div>

                    <!-- Food Item -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Food Item</label>
                        <input type="text" name="food_item" required class="form-control" placeholder="Enter Food Item">
                    </div>

                    <!-- Temperature Fields Grid -->
                    <div class="row">
                        <!-- Row 1 -->
                        <div class="col-md-4 mb-3">
                            <label style="font-family:Monospace">Temperature at 0 hours</label>
                            <input type="number" step="0.1" required name="temp_0" class="form-control" placeholder="0°C">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label style="font-family:Monospace">Temperature at 1 hour</label>
                            <input type="number" step="0.1" required name="temp_1" class="form-control" placeholder="1°C">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label style="font-family:Monospace">Temperature at 2 hours</label>
                            <input type="number" step="0.1" required name="temp_2" class="form-control" placeholder="2°C">
                        </div>
                    </div>

                    <div class="row">
                        <!-- Row 2 -->
                        <div class="col-md-4 mb-3">
                            <label style="font-family:Monospace">Temperature at 3 hours</label>
                            <input type="number" step="0.1" required name="temp_3" class="form-control" placeholder="3°C">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label style="font-family:Monospace">Temperature at 4 hours</label>
                            <input type="number" step="0.1" required name="temp_4" class="form-control" placeholder="4°C">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label style="font-family:Monospace">Temperature at 5 hours</label>
                            <input type="number" step="0.1" required name="temp_5" class="form-control" placeholder="5°C">
                        </div>
                    </div>

                    <!-- Temperature at 6 hours -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Temperature at 6 hours</label>
                        <input type="number" step="0.1" name="temp_6" required class="form-control" placeholder="6°C">
                    </div>

                    <!-- Cooling Methods -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Cooling Methods</label>
                        <select name="cooling_methods" class="form-control" required>
                            <option value="">Select Method</option>
                            <option value="blast_chiller">Blast Chiller</option>
                            <option value="ice_water_bath">Ice Water Bath</option>
                        </select>
                    </div>

                    <!-- Corrective Actions -->
                    <div class="mb-3" id="corrective-actions-container" style="display: none;">
                        <label style="font-family:Monospace">Corrective Actions</label>
                        <input type="text" name="corrective_actions" class="form-control" placeholder="Enter Corrective Actions">
                    </div>

                    <!-- Text Message -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Text Message</label>
                        <textarea name="text_message" class="form-control" rows="3" placeholder="Enter any additional notes"></textarea>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-success" id="checkAndSave">
                            Add Cooling Data
                        </button>
                    </div>
                    <div id="correctiveModal" style="display:none;">
                        <div class="modal-content">
                            <div id="correctiveMessage"></div>
                            <div id="correctiveActionsList"></div>
                            <textarea id="actionComment" placeholder="Add your comments for selected corrective actions"></textarea>
                            <button onclick="confirmSave()">Save</button>
                            <button onclick="closeModal()">Cancel</button>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<script>
document.getElementById("checkAndSave").addEventListener("click", function (event) {
    // Prevent the form submission
    event.preventDefault();
    const corrective_actions = {{ corrective_actions|safe }};

    // Get all temperature values
    const temp0 = parseFloat(document.querySelector('input[name="temp_0"]').value);
    const temp1 = parseFloat(document.querySelector('input[name="temp_1"]').value);
    const temp2 = parseFloat(document.querySelector('input[name="temp_2"]').value);
    const temp4 = parseFloat(document.querySelector('input[name="temp_4"]').value);

    // Validate temperature conditions
    if (temp0 <= temp1 || temp2 > 21 || temp4 > 5) {
        // Show corrective actions container
        const correctiveMessageDiv = document.getElementById('correctiveMessage');
        correctiveMessageDiv.innerHTML = ''; // Clear previous messages

        const correctiveActionsList = document.getElementById('correctiveActionsList');
        correctiveActionsList.innerHTML = ''; // Clear previous actions

        corrective_actions.forEach(action => {
            const actionItem = document.createElement('div');
            actionItem.innerHTML = `
                <input type="checkbox" id="action_${action}" value="${action}" />
                <label for="action_${action}">${action}</label>
            `;
            correctiveActionsList.appendChild(actionItem);
        });

       
        // Show modal
        document.getElementById('correctiveModal').style.display = 'flex';

        return;
    }

    // If conditions are met, submit the form
    event.target.closest("form").submit();
    
});
function closeModal() {
document.getElementById('correctiveModal').style.display = 'none';
}

async function confirmSave() {
    // Collect all data to send to the API
    const data_to_send = {
        storage_location: document.querySelector('input[name="storage_location"]').value,
        sub_storage_location: document.querySelector('input[name="sub_storage_location"]').value,
        food_item: document.querySelector('input[name="food_item"]').value,
        temp_0: parseFloat(document.querySelector('input[name="temp_0"]').value),
        temp_1: parseFloat(document.querySelector('input[name="temp_1"]').value),
        temp_2: parseFloat(document.querySelector('input[name="temp_2"]').value),
        temp_3: parseFloat(document.querySelector('input[name="temp_3"]').value),
        temp_4: parseFloat(document.querySelector('input[name="temp_4"]').value),
        temp_5: parseFloat(document.querySelector('input[name="temp_5"]').value),
        temp_6: parseFloat(document.querySelector('input[name="temp_6"]').value),
        cooling_methods: document.querySelector('select[name="cooling_methods"]').value,
        corrective_actions: Array.from(document.querySelectorAll('#correctiveActionsList input[type="checkbox"]:checked')).map(el => el.value),
        action_comment: document.getElementById('actionComment').value,
        text_message: document.querySelector('textarea[name="text_message"]').value
    };
    try {
        const csrftoken = getCookie('csrftoken');
        // Make the API call
        const response = await fetch('/user/Cooling/add/'+document.querySelector('input[name="storage_location"]').value+"/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken // CSRF token for Django
            },
            body: JSON.stringify(data_to_send)
        });
        if (response.ok) {
            const result = await response.json();
            console.log(result);
            alert('Data saved successfully!');
            closeModal();
            window.location.reload();
            } else {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const error = await response.json();
                    alert(`Failed to save data: ${error.message}`);
                } else {
                    const errorText = await response.text();
                    console.error('Unexpected response:', errorText);
                    alert('An unexpected error occurred.');
                }
            }
    } catch (err) {
        console.error('Error saving data:', err);
        alert('An unexpected error occurred while saving data.');
    }
}
function getCookie(name) {
let cookieValue = null;
if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
        }
    }
}
return cookieValue;
}


</script>
{% endblock javascripts %}