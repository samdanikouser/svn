{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Add Reheating Data{% endblock %}
{% block stylesheets %}<link rel="stylesheet" type="text/css" href="{% static 'assets/css/user_first_page.css' %}">
{% endblock stylesheets %}

{% block content %}
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} message" id="message-{{ forloop.counter }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div style="display: flex; justify-content: space-between; padding: 20px;">
    <a href="javascript:history.back()" class="btn btn-primary btn-sm" style="text-decoration: none; font-size: 16px;">Back</a>
    <a href="{% url 'reheating_data_list' control_point.location.name %}" style="text-decoration: none; font-size: 16px;" class="btn btn-primary btn-sm">Show Reheating data</a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Add Reheating Data</h4>
            </div>
            <div class="card-body">
                    {% csrf_token %}
                    <!-- Storage Location -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Storage Location</label>
                        <input type="text" name="storage_location" class="form-control" readonly value="{{control_point.location.name}}">
                    </div>

                    <!-- Sub Storage Location -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Sub Storage Location</label>
                        <input type="text" name="sub_storage_location" class="form-control" readonly value="{{control_point.name}}">
                    </div>

                    <!-- Food Item -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Food Item</label>
                        <input type="text" name="food_item" required class="form-control" placeholder="Enter Food Item">
                    </div>

                    <div class="mb-3">
                        <label style="font-family:Monospace">Reheating Temperature</label>
                        <input type="number" step="0.1" required name="temp" class="form-control" placeholder="3Â°C">
                    </div>

                     <!-- Temperature at 6 hours -->
                     <div class="mb-3">
                        <label style="font-family:Monospace">Date of Reheating</label>
                        <input type="date" name="date_of_reheating" id="date_of_reheating" required class="form-control">
                    </div>
            

                    <!-- Temperature at 6 hours -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Time taken for Reheating</label>
                        <input type="number" name="hours" id="hours" required placeholder="Hours (0-2)" class="form-control">
        
                        <input type="number" name="minutes" id="minutes" required placeholder="Minutes (0-59)" class="form-control">
                        
                        <small class="form-text text-muted">Time must be less than 2 hours.</small>
                    </div>

                    <!-- Corrective Actions -->
                    <div class="mb-3" id="corrective-actions-container" style="display: none;">
                        <label style="font-family:Monospace">Corrective Actions</label>
                        <input type="text" name="corrective_actions" class="form-control" placeholder="Enter Corrective Actions">
                    </div>

                    <!-- Text Message -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Text Message</label>
                        <textarea name="text_message" class="form-control" rows="3" placeholder="Enter any additional notes"></textarea>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-success" id="checkAndSave">
                            Add Reheating Data
                        </button>
                    </div>
                    <div id="correctiveModal" style="display:none;">
                        <div class="modal-content">
                            <div id="correctiveMessage"></div>
                            <div id="correctiveActionsList"></div>
                            <textarea id="actionComment" placeholder="Add your comments for selected corrective actions"></textarea>
                            <button onclick="confirmSave()">Save</button>
                            <button onclick="closeModal()">Cancel</button>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<script>
document.getElementById("checkAndSave").addEventListener("click", function (event) {
    // Prevent the form submission
    event.preventDefault();
    const corrective_actions = {{ corrective_actions|safe }};

    // Get all temperature values
    const temp = parseFloat(document.querySelector('input[name="temp"]').value);
    const hours = document.getElementById('hours').value;
    const minutes = document.getElementById('minutes').value;

    // Convert the time to total minutes
    const totalMinutes = (parseInt(hours) * 60) + parseInt(minutes);

    // Validate temperature conditions
    if (temp <= 75 || totalMinutes > 120) {
        // Show corrective actions container
        const correctiveMessageDiv = document.getElementById('correctiveMessage');
        correctiveMessageDiv.innerHTML = ''; // Clear previous messages

        const correctiveActionsList = document.getElementById('correctiveActionsList');
        correctiveActionsList.innerHTML = ''; // Clear previous actions

        corrective_actions.forEach(action => {
            const actionItem = document.createElement('div');
            actionItem.innerHTML = `
                <input type="checkbox" id="action_${action}" value="${action}" />
                <label for="action_${action}">${action}</label>
            `;
            correctiveActionsList.appendChild(actionItem);
        });

       
        // Show modal
        document.getElementById('correctiveModal').style.display = 'flex';

        return;
    }

    // If conditions are met, submit the form
    confirmSave()
    
});
function closeModal() {
document.getElementById('correctiveModal').style.display = 'none';
}

async function confirmSave() {
    // Collect all data to send to the API
    const hours = document.getElementById('hours').value;
    const minutes = document.getElementById('minutes').value;

    // Convert the time to total minutes
    const totalMinutes = (parseInt(hours) * 60) + parseInt(minutes);


    const data_to_send = {
        storage_location: document.querySelector('input[name="storage_location"]').value,
        sub_storage_location: document.querySelector('input[name="sub_storage_location"]').value,
        date_of_reheating:document.querySelector('input[name="date_of_reheating"]').value,
        food_item: document.querySelector('input[name="food_item"]').value,
        temp: parseFloat(document.querySelector('input[name="temp"]').value),
        time_taken:totalMinutes,
        corrective_actions: Array.from(document.querySelectorAll('#correctiveActionsList input[type="checkbox"]:checked')).map(el => el.value),
        action_comment: document.getElementById('actionComment').value,
        text_message: document.querySelector('textarea[name="text_message"]').value
    };
    try {
        const csrftoken = getCookie('csrftoken');
        // Make the API call
        const response = await fetch('/user/Re-Heating/add/'+document.querySelector('input[name="storage_location"]').value+"/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken // CSRF token for Django
            },
            body: JSON.stringify(data_to_send)
        });
        if (response.ok) {
            const result = await response.json();
            console.log(result);
            alert('Data saved successfully!');
            closeModal();
            window.location.reload();
            } else {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const error = await response.json();
                    alert(`Failed to save data: ${error.message}`);
                } else {
                    const errorText = await response.text();
                    console.error('Unexpected response:', errorText);
                    alert('An unexpected error occurred.');
                }
            }
    } catch (err) {
        console.error('Error saving data:', err);
        alert('An unexpected error occurred while saving data.');
    }
}
function getCookie(name) {
let cookieValue = null;
if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
        }
    }
}
return cookieValue;
}


</script>
{% endblock javascripts %}