{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Add Cooking Data{% endblock %}
{% block stylesheets %}<link rel="stylesheet" type="text/css" href="{% static 'assets/css/user_first_page.css' %}">
{% endblock stylesheets %}

{% block content %}
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} message" id="message-{{ forloop.counter }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div style="display: flex; justify-content: space-between; padding: 20px;">
    <a href="javascript:history.back()" class="btn btn-primary btn-sm" style="text-decoration: none; font-size: 16px;">Back</a>
    <a href="{% url 'cooking_data_list' control_point.location.name %}" style="text-decoration: none; font-size: 16px;" class="btn btn-primary btn-sm">Show Cooking data</a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Add Cooking Data</h4>
            </div>
            <div class="card-body">
            
                    
                    <!-- Storage Location -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Storage Location</label>
                        <input type="text" name="storage_location" class="form-control" readonly value="{{control_point.location.name}}">
                    </div>

                    <!-- Sub Storage Location -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Sub Storage Location</label>
                        <input type="text" name="sub_storage_location" class="form-control" readonly value="{{control_point.name}}">
                    </div>
                    
                    <div class="mb-3">
                        <label style="font-family:Monospace">Meal Periode</label>
                        <select name="food_type" required class="form-control">
                            <option value="">Select Meal Period</option>
                            <option value="breaffast">BreafFast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                    </div>

                     <!-- Food Item -->
                     <div class="mb-3">
                        <label style="font-family:Monospace">Item Name</label>
                        <input type="text" name="item_name" required class="form-control" placeholder="Enter Food Item">
                    </div>


                    <!-- Temperature at 6 hours -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Time</label>
                        <input type="time" name="time" required class="form-control" placeholder="Time">
                    </div>

                    <div class="mb-3">
                        <label style="font-family:Monospace">Temperature</label>
                        <input type="number" step="0.1" required name="temperature" class="form-control" placeholder="2Â°C">
                    </div>

                    <div class="mb-3">
                        <label style="font-family:Monospace">Food Type</label>
                        <select name="food_type" required class="form-control">
                            <option value="">Select Food Type</option>
                            <option value="beef">Beef</option>
                            <option value="pork">Pork</option>
                            <option value="seafood">Seafood</option>
                            <option value="lamb">Lamb</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    

                    <!-- Corrective Actions -->
                    <div class="mb-3" id="corrective-actions-container" style="display: none;">
                        <label style="font-family:Monospace">Corrective Actions</label>
                        <input type="text" name="corrective_actions" class="form-control" placeholder="Enter Corrective Actions">
                    </div>

                    <!-- Text Message -->
                    <div class="mb-3">
                        <label style="font-family:Monospace">Text Message</label>
                        <textarea name="text_message" class="form-control" rows="3" placeholder="Enter any additional notes"></textarea>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-success" id="checkAndSave">
                            Add Cooking Data
                        </button>
                    </div>
                    <div id="correctiveModal" style="display:none;">
                        <div class="modal-content">
                            <div id="correctiveMessage"></div>
                            <div id="correctiveActionsList"></div>
                            <textarea id="actionComment" placeholder="Add your comments for selected corrective actions"></textarea>
                            <button onclick="confirmSave()">Save</button>
                            <button onclick="closeModal()">Cancel</button>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<script>
document.getElementById("checkAndSave").addEventListener("click", function (event) {
    // Prevent the form submission
    event.preventDefault();

    const corrective_actions = {{ corrective_actions|safe }}; // Django context variable

    // Get temperature and food type values
    const temp = parseFloat(document.querySelector('input[name="temperature"]').value);
    const food_type = document.querySelector('select[name="food_type"]').value; // Assuming dropdown for food type

    // Define thresholds
    const seafoodTempThreshold = 63;
    const otherTempThreshold = 74;

    let showCorrectiveActions = false;

    // Check conditions based on food type
    if (food_type === 'seafood' && temp >= seafoodTempThreshold) {
        showCorrectiveActions = true;
    } else if (food_type !== 'seafood' && food_type !== 'other' && temp >= otherTempThreshold) {
        showCorrectiveActions = true;
    }

    if (showCorrectiveActions) {
        // Display corrective actions
        const correctiveMessageDiv = document.getElementById('correctiveMessage');
        correctiveMessageDiv.innerHTML = ''; // Clear previous messages

        const correctiveActionsList = document.getElementById('correctiveActionsList');
        correctiveActionsList.innerHTML = ''; // Clear previous actions

        corrective_actions.forEach(action => {
            const actionItem = document.createElement('div');
            actionItem.innerHTML = `
                <input type="checkbox" id="action_${action}" value="${action}" />
                <label for="action_${action}">${action}</label>
            `;
            correctiveActionsList.appendChild(actionItem);
        });

        // Show modal
        document.getElementById('correctiveModal').style.display = 'flex';
        return; // Exit the function to prevent form submission
    }

    // Submit the form if no corrective actions are required
    event.target.closest("form").submit();
});

function closeModal() {
document.getElementById('correctiveModal').style.display = 'none';
}

async function confirmSave() {
    // Collect all data to send to the API
    const data_to_send = {
        storage_location: document.querySelector('input[name="storage_location"]').value,
        sub_storage_location: document.querySelector('input[name="sub_storage_location"]').value,
        food_item: document.querySelector('input[name="item_name"]').value,
        time: document.querySelector('input[name="time"]').value,
        temperature: parseFloat(document.querySelector('input[name="temperature"]').value),
        food_type: document.querySelector('select[name="food_type"]').value,
        corrective_actions: Array.from(document.querySelectorAll('#correctiveActionsList input[type="checkbox"]:checked')).map(el => el.value),
        action_comment: document.getElementById('actionComment').value,
        text_message: document.querySelector('textarea[name="text_message"]').value
    };
    try {
        const csrftoken = getCookie('csrftoken');
        // Make the API call
        const response = await fetch('/user/cooking/add/'+document.querySelector('input[name="storage_location"]').value+"/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken // CSRF token for Django
            },
            body: JSON.stringify(data_to_send)
        });
        if (response.ok) {
            const result = await response.json();
            console.log(result);
            alert('Data saved successfully!');
            closeModal();
            window.location.reload();
            } else {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const error = await response.json();
                    alert(`Failed to save data: ${error.message}`);
                } else {
                    const errorText = await response.text();
                    console.error('Unexpected response:', errorText);
                    alert('An unexpected error occurred.');
                }
            }
    } catch (err) {
        console.error('Error saving data:', err);
        alert('An unexpected error occurred while saving data.');
    }
}
function getCookie(name) {
let cookieValue = null;
if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
        }
    }
}
return cookieValue;
}


</script>
{% endblock javascripts %}