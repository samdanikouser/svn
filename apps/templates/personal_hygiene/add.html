{% extends "layouts/base.html" %}
{% load static %}

{% block stylesheets %}
<link rel="stylesheet" type="text/css" href="{% static 'assets/css/personal_hygiene_add.css' %}">
{% endblock stylesheets %}

{% block title %}Personal Hygiene Inspection{% endblock %}

{% block content %}
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} message" id="message-{{ forloop.counter }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div style="display: flex; justify-content: space-between; padding: 20px;">
    <a href="javascript:history.back()" class="btn btn-primary btn-sm d-flex align-items-center" style="text-decoration: none; font-size: 16px;">
        <i class="material-icons" style="font-size: 20px; margin-right: 8px;">arrow_back</i> Back
    </a>
    {% if user_role == 'admin' or user_role == 'manager' %}
    <a href="{% url 'personalhygiene_list' %}" style="text-decoration: none; font-size: 16px;" class="btn btn-primary btn-sm">List</a>
    {%endif%}
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Personal Hygiene Inspection</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="personalHygieneForm">
                    {% csrf_token %}
                    
                    <!-- Employee Name Dropdown -->
                    <div class="form-group mb-4">
                        <label for="employee" class="font-weight-bold">Employee Name:</label>
                        <select id="employee" name="employee" class="form-control custom-select" required>
                            <option value="" selected disabled>Select Employee</option>
                            {% for profile in user_profiles %}
                                <option value="{{ profile.id }}"
                                        data-employee-id="{{ profile.employee_id }}"
                                        data-position="{{ profile.job_title }}"
                                        data-department="{{ profile.department }}">
                                    {{ profile.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
            
                    <!-- Employee ID, Position and Department (Read-Only) -->
                    <div class="form-row mb-4">
                        <div class="form-group col-md-4">
                            <label for="employee_id" class="font-weight-bold">Employee ID:</label>
                            <input type="text" id="employee_id" name="employee_id" class="form-control" readonly>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="position" class="font-weight-bold">Position:</label>
                            <input type="text" id="position" name="position" class="form-control" readonly>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="department" class="font-weight-bold">Department:</label>
                            <input type="text" id="department" name="department" class="form-control" readonly>
                        </div>
                    </div>
            
                    <!-- Inspection Date (Read-Only) -->
                    <div class="form-group mb-4">
                        <label for="inspection_date" class="font-weight-bold">Inspection Date:</label>
                        <input type="date" id="inspection_date" name="inspection_date" class="form-control" readonly>
                    </div>
            
                    <!-- Parameters to Check -->
                    <div class="form-group mb-4">
                        <label for="parameters_checked" class="font-weight-bold">Parameters to Check:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label>1. Knowledge of Personal Hygiene:</label>
                                <select name="knowledge_of_personal_hygiene" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Knowledge of Personal Hygiene : Yes">Yes</option>
                                    <option value="Knowledge of Personal Hygiene : No">No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>2. Trimmed/Shaved Beard and Moustache:</label>
                                <select name="trimmed_beard_moustache" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Trimmed/Shaved Beard and Moustache : Yes">Yes</option>
                                    <option value="Trimmed/Shaved Beard and Moustache : No">No</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label>3. Overall Health:</label>
                                <select name="overall_health" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Overall Health : Yes">Yes</option>
                                    <option value="Overall Health : No">No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>4. Short Nails:</label>
                                <select name="short_nails" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Short Nails : Yes">Yes</option>
                                    <option value="Short Nails : No">No</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label>5. Overall Cleanliness:</label>
                                <select name="overall_cleanliness" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Overall Cleanliness : Yes">Yes</option>
                                    <option value="Overall Cleanliness : No">No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>6. Cleaned Hands:</label>
                                <select name="cleaned_hands" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Cleaned Hands : Yes">Yes</option>
                                    <option value="Cleaned Hands : No">No</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label>7. Proper Uniform:</label>
                                <select name="proper_uniform" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Proper Uniform : Yes">Yes</option>
                                    <option value="Proper Uniform : No">No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>8. Trimmed Hair:</label>
                                <select name="trimmed_hair" class="form-control" required>
                                    <option value="--">--</option>
                                    <option value="Trimmed Hair : Yes">Yes</option>
                                    <option value="Trimmed Hair : No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div class="form-group mb-4">
                        <label for="photos" class="font-weight-bold">Take Photos:</label>
                        <input type="file" id="photos" name="photos" class="form-control" accept="image/*" capture="camera" multiple required>
                        <div id="fileNameDisplay" class="mt-2"></div>
                    </div>

                    <!-- Signature -->
                    <div class="form-group mb-4">
                        <div class="row">
                            <div class="form-group mb-6">
                                <label for="signature" class="font-weight-bold">Inspector Signature:</label>
                                <canvas id="signature-pad" name="inspector_signature" style="border: 1px solid #ccc; width: 100%; height: 150px;"></canvas>
                                <br>
                                <button type="button" id="clear-signature" class="btn btn-secondary btn-sm">Clear Signature</button>
                            </div>
                            <div class="form-group mb-6">
                                <label for="employee_signature" class="font-weight-bold">Employee Signature:</label>
                                <canvas id="employee_signature-pad" name="employee_signature" style="border: 1px solid #ccc; width: 100%; height: 150px;"></canvas>
                                <br>
                                <button type="button" id="clear-employee-signature" class="btn btn-secondary btn-sm">Clear Signature</button>
                            </div>
                        </div>
                    </div>
            
                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Submit Inspection</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Set today's date in the inspection_date field
        const today = new Date().toISOString().split('T')[0];
        $('#inspection_date').val(today);

        // Populate employee ID and position based on selected employee
        $('#employee').on('change', function () {
            const selectedOption = $(this).find(':selected');
            const employeeId = selectedOption.data('employee-id');
            const position = selectedOption.data('position');
            const department = selectedOption.data('department');

            $('#employee_id').val(employeeId);
            $('#position').val(position);
            $('#department').val(department);
        });

        // Handle file input change
        const photosInput = document.getElementById('photos');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        photosInput.addEventListener('change', function (event) {
            const files = event.target.files;
            fileNameDisplay.innerHTML = ''; // Clear previous thumbnails

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.alt = file.name;
                    img.style.maxWidth = '100px';
                    img.style.margin = '5px';
                    fileNameDisplay.appendChild(img);
                }
            });
        });

        // Signature pad setup for inspector signature
        const signaturePad = new SignaturePad(document.getElementById('signature-pad'));
        const clearSignatureBtn = document.getElementById('clear-signature');
        clearSignatureBtn.addEventListener('click', () => signaturePad.clear());

        // Signature pad setup for employee signature
        const employeeSignaturePad = new SignaturePad(document.getElementById('employee_signature-pad'));
        const clearEmployeeSignatureBtn = document.getElementById('clear-employee-signature');
        clearEmployeeSignatureBtn.addEventListener('click', () => employeeSignaturePad.clear());

        // Before submitting the form, serialize the signature data and add it as hidden fields
        const form = document.getElementById('personalHygieneForm');
        form.addEventListener('submit', function (event) {
            // Get the signature data URLs
            const inspectorSignatureData = signaturePad.isEmpty() ? '' : signaturePad.toDataURL();
            const employeeSignatureData = employeeSignaturePad.isEmpty() ? '' : employeeSignaturePad.toDataURL();

            // Create hidden inputs for the signature data
            const inspectorSignatureInput = document.createElement('input');
            inspectorSignatureInput.type = 'hidden';
            inspectorSignatureInput.name = 'inspector_signature';
            inspectorSignatureInput.value = inspectorSignatureData;
            form.appendChild(inspectorSignatureInput);

            const employeeSignatureInput = document.createElement('input');
            employeeSignatureInput.type = 'hidden';
            employeeSignatureInput.name = 'employee_signature';
            employeeSignatureInput.value = employeeSignatureData;
            form.appendChild(employeeSignatureInput);
        });
    });
</script>
{% endblock %}
