{% extends "layouts/base.html" %}
{% load static %}

{% block stylesheets %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@material-ui/core@5.0.0-alpha.40/dist/material-ui-core.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'assets/css/personal_hygiene_add.css' %}">
<style>
    body {
        background-color: #f7f7f7;
        font-family: 'Roboto', sans-serif;
    }

    .form-container {
        max-width: 1200px;
        margin: 50px auto;
        background-color: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .form-header {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 30px;
        color: #9c27b0;
    }

    .form-row {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
        min-width: 220px;
    }

    .form-group label {
        font-weight: 500;
        font-size: 14px;
        color: #555;
        margin-bottom: 8px;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        color: #555;
        transition: all 0.3s ease;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
        border-color: #3f51b5;
        outline: none;
    }

    .signature-container {
        display: flex;
        gap: 20px;
        justify-content: space-between;
        margin-top: 40px;
    }
    .form-group .bmd-label-static {
    top: -21px;
}
    .signature-box {
        width: 48%;
        border: 2px solid #ddd;
        padding: 20px;
        border-radius: 8px;
        background-color: #fafafa;
        text-align: center;
    }

    .signature-box canvas {
        width: 100%;
        height: 180px;
        border-radius: 8px;
        background-color: #fff;
        border: 2px solid #ddd;
    }

    .signature-box button {
        margin-top: 12px;
        padding: 8px 20px;
        background-color: #3f51b5;
        color: white;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .signature-box button:hover {
        background-color: #303f9f;
    }

    .form-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }

    .form-buttons .btn {
        padding: 14px 30px;
        background-color: #9c27b0;
        color: white;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .form-buttons .btn:hover {
        background-color: #303f9f;
    }

    .alert {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }

    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-color: #bee5eb;
    }
</style>
{% endblock stylesheets %}

{% block title %}Personal Hygiene Inspection{% endblock %}


{% block content %}
<div class="form-container">
    {% if messages %}
        <div class="alert alert-{{ message.tags }} message">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}


    <h2 class="form-header">Personal Hygiene Inspection</h2>
    <div class="d-flex justify-content-between mb-4">
        <a href="javascript:history.back()" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <a href="{% url 'personalhygiene_list' %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-left"></i> List
        </a>
    </div>

    <form method="post" enctype="multipart/form-data" id="personalHygieneForm">
        {% csrf_token %}

        <!-- Employee Information Section -->
        <div class="form-row">
            <div class="form-group">
                <label for="employee">Employee Name:</label>
                <select id="employee" name="employee" class="form-control custom-select" required>
                    <option value="" selected disabled>Select Employee</option>
                    {% for profile in user_profiles %}
                        <option value="{{ profile.id }}"
                                data-employee-id="{{ profile.employee_id }}"
                                data-position="{{ profile.job_title }}"
                                data-department="{{ profile.department }}">
                            {{ profile.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Employee ID, Position, and Department -->
        <div class="form-row">
            <div class="form-group">
                <label for="employee_id">Employee ID:</label>
                <input type="text" id="employee_id" name="employee_id" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="position">Position:</label>
                <input type="text" id="position" name="position" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="department">Department:</label>
                <input type="text" id="department" name="department" class="form-control" readonly>
            </div>
        </div>

        <!-- Inspection Date -->
        <div class="form-group">
            <label for="inspection_date">Inspection Date:</label>
            <input type="date" id="inspection_date" name="inspection_date" class="form-control" readonly>
        </div>

        <!-- Parameters to Check Section -->
        <div class="form-group">
            <label class="font-weight-bold">Parameters to Check:</label>
            <div class="form-row">
                <div class="form-group">
                    <label>1. Knowledge of Personal Hygiene:</label>
                    <select name="knowledge_of_personal_hygiene" class="form-control" required>
                        <option value="--">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>2. Trimmed/Shaved Beard and Moustache:</label>
                    <select name="trimmed_beard_moustache" class="form-control" required>
                        <option value="--">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
            </div>

            <!-- Additional Parameters -->
            <div class="form-row">
                <div class="form-group">
                    <label>3. Overall Health:</label>
                    <select name="overall_health" class="form-control" required>
                        <option value="--">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>4. Short Nails:</label>
                    <select name="short_nails" class="form-control" required>
                        <option value="--">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
            </div>

            <!-- Further Parameters -->
            <div class="form-row">
                <div class="form-group">
                    <label>5. Overall Cleanliness:</label>
                    <select name="overall_cleanliness" class="form-control" required>
                        <option value="--">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>6. Cleaned Hands:</label>
                    <select name="cleaned_hands" class="form-control" required>
                        <option value="--">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="form-group">
            <label for="photos">Take Photos:</label>
            <input type="file" id="photos" name="photos" class="form-control" accept="image/*" capture="camera" multiple required>
            <div id="fileNameDisplay" class="mt-2"></div>
        </div>

        <!-- Signature Section -->
        <div class="signature-container">
            <div class="signature-box">
                <label for="signature">Inspector Signature:</label>
                <canvas id="signature-pad" name="inspector_signature"></canvas>
                <button type="button" id="clear-signature" class="btn btn-sm">Clear Signature</button>
            </div>
            <div class="signature-box">
                <label for="employee_signature">Employee Signature:</label>
                <canvas id="employee_signature-pad" name="employee_signature"></canvas>
                <button type="button" id="clear-employee-signature" class="btn btn-sm">Clear Signature</button>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="form-buttons">
            <button type="submit" class="btn btn-lg">Submit Inspection</button>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date().toISOString().split('T')[0];
        $('#inspection_date').val(today);

        // Populate employee info
        $('#employee').on('change', function () {
            const selectedOption = $(this).find(':selected');
            const employeeId = selectedOption.data('employee-id');
            const position = selectedOption.data('position');
            const department = selectedOption.data('department');

            $('#employee_id').val(employeeId);
            $('#position').val(position);
            $('#department').val(department);
        });

        // File input display
        const photosInput = document.getElementById('photos');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        photosInput.addEventListener('change', function (event) {
            const files = event.target.files;
            fileNameDisplay.innerHTML = ''; // Clear previous thumbnails

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.alt = file.name;
                    img.style.maxWidth = '100px';
                    img.style.margin = '5px';
                    fileNameDisplay.appendChild(img);
                }
            });
        });

        const form = document.getElementById('personalHygieneForm');
        form.addEventListener('submit', function (event) {
            // Get the signature data URLs
            const inspectorSignatureData = signaturePad.isEmpty() ? '' : signaturePad.toDataURL();
            const employeeSignatureData = employeeSignaturePad.isEmpty() ? '' : employeeSignaturePad.toDataURL();

            // Create hidden inputs for the signature data
            const inspectorSignatureInput = document.createElement('input');
            inspectorSignatureInput.type = 'hidden';
            inspectorSignatureInput.name = 'inspector_signature';
            inspectorSignatureInput.value = inspectorSignatureData;
            form.appendChild(inspectorSignatureInput);

            const employeeSignatureInput = document.createElement('input');
            employeeSignatureInput.type = 'hidden';
            employeeSignatureInput.name = 'employee_signature';
            employeeSignatureInput.value = employeeSignatureData;
            form.appendChild(employeeSignatureInput);
        });

        // Signature pads
        const signaturePad = new SignaturePad(document.getElementById('signature-pad'));
        document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());

        const employeeSignaturePad = new SignaturePad(document.getElementById('employee_signature-pad'));
        document.getElementById('clear-employee-signature').addEventListener('click', () => employeeSignaturePad.clear());
    });
</script>
{% endblock %}
